#!/bin/bash
# Pre-commit hook: runs before each commit
# Optimized for speed with incremental caching
set -e

echo "Running pre-commit guardrails..."

# Get staged Python files only (for speed)
staged_py=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$staged_py" ]; then
    echo "No Python files staged, skipping Python checks."
    exit 0
fi

# 1. Format check (fast)
echo "  [1/4] Format check..."
if command -v make >/dev/null 2>&1; then
    make format-incremental 2>&1 | tail -3 || uv run ruff format --check . 2>&1 | tail -5
else
    uv run ruff format --check . 2>&1 | tail -5
fi

# 2. Lint check (incremental)
echo "  [2/4] Lint check..."
if command -v make >/dev/null 2>&1; then
    # Only check staged files for speed
    echo "$staged_py" | xargs uv run ruff check 2>&1 | tail -5 || true
else
    echo "$staged_py" | xargs uv run ruff check 2>&1 | tail -5 || true
fi

# 3. Debug statement detection (staged files only)
echo "  [3/4] Debug statement check..."
if echo "$staged_py" | xargs grep -l "breakpoint()\|import pdb\|pdb.set_trace\|from pdb import" 2>/dev/null; then
    echo ""
    echo "❌ ERROR: Debug statements found in staged files. Remove before committing."
    exit 1
fi

# 4. Secret detection (basic patterns in staged files)
echo "  [4/4] Secret scan..."
potential_secrets=$(echo "$staged_py" | xargs grep -l "api_key\|apikey\|password\s*=\|secret\s*=" 2>/dev/null || true)
if [ -n "$potential_secrets" ]; then
    echo ""
    echo "⚠️  WARNING: Potential secrets found in:"
    echo "$potential_secrets" | sed 's/^/    /'
    echo ""
    echo "   Review manually. If false positives, use: git commit --no-verify"
    echo ""
    # Don't fail, just warn
fi

# 5. Branch protection
echo "  [5/6] Branch check..."
branch=$(git branch --show-current)
if [ "$branch" = "main" ]; then
    echo ""
    echo "❌ ERROR: Direct commits to main not allowed."
    echo "   Create a feature branch: git checkout -b feature/your-feature"
    exit 1
fi

# 6. Import check (critical)
echo "  [6/6] API import check..."
if ! python -c "from api import app" 2>/dev/null; then
    echo ""
    echo "❌ ERROR: API imports failed. Check for missing modules."
    echo "   Run: python -c 'from api import app' for details"
    exit 1
fi

# 7. Full health check on critical file changes (optional, can be skipped with --no-verify)
# Check if critical backend files changed
critical_changed=$(git diff --cached --name-only | grep -E "(api/|integrations/imessage|jarvis/)" | head -5 || true)
if [ -n "$critical_changed" ]; then
    echo ""
    echo "Critical backend files changed - running full health check..."
    if ! python scripts/health_check.py; then
        echo ""
        echo "❌ Health check failed. Fix issues before committing."
        echo "   Or skip with: git commit --no-verify (not recommended)"
        exit 1
    fi
fi

echo ""
echo "✅ Pre-commit checks passed!"
