#!/bin/bash
# Pre-push hook: runs before pushing to remote
# Ensures full verification passes before code leaves local machine
set -e

echo "Running pre-push guardrails..."

# 1. Run full verification (uses incremental caching where possible)
echo "  [1/5] Running verification..."
if command -v make >/dev/null 2>&1; then
    make verify 2>&1 | tail -20
else
    echo "Make not found, running manual verification..."
    uv run ruff check . || true
    uv run ruff format --check . || true
    uv run mypy jarvis/ core/ models/ api/ --ignore-missing-imports || true
    uv run pytest tests/ --tb=short -q --timeout=30 2>&1 | tail -10
fi

# 2. Test results validation
echo "  [2/5] Validating test results..."
if [ ! -f test_results.txt ]; then
    echo ""
    echo "❌ ERROR: test_results.txt not found. Run 'make test' before pushing."
    exit 1
fi

if grep -q "FAILED\|ERROR" test_results.txt; then
    # Count failures
    failed_count=$(grep -c "FAILED" test_results.txt 2>/dev/null || echo "0")
    echo ""
    echo "❌ ERROR: $$failed_count test(s) failing. Fix before pushing."
    echo ""
    echo "Failed tests:"
    grep "FAILED" test_results.txt | head -10 | sed 's/^/  /'
    exit 1
fi

# 3. Coverage check
echo "  [3/5] Checking coverage..."
coverage_line=$(grep -E "TOTAL|total" test_results.txt 2>/dev/null | tail -1 || echo "")
if echo "$coverage_line" | grep -q "%"; then
    coverage=$(echo "$coverage_line" | grep -o "[0-9]*%" | tail -1 | tr -d '%' || echo "0")
    if [ "$coverage" -lt 50 ] 2>/dev/null; then
        echo "⚠️  WARNING: Coverage is ${coverage}% (minimum 50% recommended)"
    else
        echo "    Coverage: ${coverage}%"
    fi
fi

# 4. Branch naming convention
echo "  [4/5] Checking branch name..."
branch=$(git branch --show-current)
if ! echo "$branch" | grep -qE "^(feature|bugfix|hotfix|refactor|docs|test)/|^main$"; then
    echo ""
    echo "⚠️  WARNING: Branch name '$branch' doesn't follow convention."
    echo "   Expected: feature/*, bugfix/*, hotfix/*, refactor/*, docs/*, test/*"
    echo ""
fi

# 5. Commit message format check
echo "  [5/5] Checking commit format..."
# Check all commits being pushed
commits=$(git log --oneline origin/$(git rev-parse --abbrev-ref HEAD)..HEAD 2>/dev/null || echo "")
if [ -z "$commits" ]; then
    commits=$(git log --oneline -5)
fi

# Check the most recent commit
latest_commit=$(echo "$commits" | head -1)
commit_msg=$(echo "$latest_commit" | cut -d' ' -f2-)
if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|refactor|test|chore|perf|ci|build):"; then
    echo ""
    echo "⚠️  WARNING: Commit message doesn't follow conventional commits:"
    echo "   '$commit_msg'"
    echo ""
    echo "   Expected format: <type>: <description>"
    echo "   Types: feat, fix, docs, refactor, test, chore, perf, ci, build"
    echo ""
    echo "   Example: feat: add contact fact extraction"
fi

echo ""
echo "✅ Pre-push checks passed! Safe to push."
